<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">     
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>詞綴收益計算</title>
    <link rel="shortcut icon" href="./img/favicon32.ico" type="image/x-icon">
    <link rel="stylesheet" href="./css/style.css">
    <script src="./js/jquery-3.5.1.min.js"></script>
    <script src="./js/jQueryRotate.js"></script>
    <!-- bootstrap-4.5.0-dist -->
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-12 mt-2">
                <h1 class="text-center">詞綴收益計算</h1>
            </div>
        </div>       
        <div class="row justify-content-center">
            <!-- <table class="table table-striped table-borderless table-sm table-dark rounded col-xl-4 col-lg-5 col-md-7 col-sm-9 col-11 mt-4"> -->
            <table class="table table-striped table-sm table-bordered table-dark mt-4 mb-4 h4">       
                <tr>
                    <td class="font-weight-bold pl-3"><label for="level">女武神等級</label></td>
                    <td class="text-right pr-3"><input type="number" id="level" class="bg-transparent text-white text-right font-weight-bolder border-0" value="80" min="1" max="80"></td>
                </tr>
                <tr>
                    <td class="font-weight-bold pl-3"><label for="atk">攻擊</label>
                        <img src="./img/BtnInfo.png" alt="info" class="info" data-toggle="tooltip" data-placement="right" title="填基本屬性顯示的數值即可">
                    </td>
                    <td class="text-right pr-3"><input type="number" id="atk" class="bg-transparent text-white text-right font-weight-bolder border-0" min="1"></td>
                </tr>
                <tr>
                    <td class="font-weight-bold pl-3"><label for="crt">會心</label>
                        <img src="./img/BtnInfo.png" alt="info" class="info" data-toggle="tooltip" data-placement="right" title="填基本屬性顯示的數值即可">
                    </td>
                    <td class="text-right pr-3"><input type="number" id="crt" class="bg-transparent text-white text-right font-weight-bolder border-0" min="1"></td>
                </tr>
                <tr>
                    <td class="font-weight-bold  align-top pl-3"><label for="crit_rate">爆擊率</label>
                        <a class="btn btn-sm btn-outline-info" data-toggle="collapse" href="#crit_rate_sum" role="button" aria-expanded="false" aria-controls="collapse" id="crit_rate_sum_help">加總小幫手</a>
                        <ul class="list-unstyled collapse p-1 h5 text-right" id="crit_rate_sum">
                            <li class="sum_li"><label for="crit_rate_leader_skill">隊長技能</label></li>
                            <li class="sum_li"><label for="crit_rate_passive">被動技能</label></li>
                            <li class="sum_li"><label for="crit_rate_weapon">武器加成</label></li>
                            <li class="sum_li"><label for="crit_rate_stigmata">聖痕加成</label></li>         
                            <li class="sum_li">
                                <img src="./img/BtnInfo.png" alt="info" class="info_s" data-toggle="tooltip" data-placement="left" data-html="true" title="封印之劍勳章 2%<br>輝煌MVP勳章 2%<br>42號勳章 1%">
                                <label for="crit_rate_medal">勳章加成</label>
                            </li>
                            <li class="sum_li"><label for="crit_rate_support">隊友輔助</label></li>
                            <li class="sum_li">
                                <img src="./img/BtnInfo.png" alt="info" class="info_s" data-toggle="tooltip" data-placement="left" data-html="true" title="魂吸I 2%<br>魂吸II 3%<br>魂吸III 4%">
                                <label for="crit_rate_divine_keys">侵蝕之鍵</label>
                            </li>
                        </ul>
                    </td>
                    <td class="text-right font-weight-bolder pr-3">
                        <div><span id="crit_rate_text">0</span> %</div>
                        <!-- <input type="number" id="crit_rate" class="bg-transparent text-white text-right font-weight-bolder border-0" min="0" step="0.1">% -->
                        <ul class="list-unstyled collapse p-1 h5" id="crit_rate_sum">
                            <li><span data-unit="%" class="percentage_sum position-relative"><input type="number" id="crit_rate_leader_skill" class="crit_rate bg-transparent text-white text-right font-weight-bolder border-0" min="0" step="0.1"></li></span>
                            <li><span data-unit="%" class="percentage_sum position-relative"><input type="number" id="crit_rate_passive" class="crit_rate bg-transparent text-white text-right font-weight-bolder border-0" step="0.1"></li></span>
                            <li><span data-unit="%" class="percentage_sum position-relative"><input type="number" id="crit_rate_weapon" class="crit_rate bg-transparent text-white text-right font-weight-bolder border-0" step="0.1"></li></span>
                            <li><span data-unit="%" class="percentage_sum position-relative"><input type="number" id="crit_rate_stigmata" class="crit_rate bg-transparent text-white text-right font-weight-bolder border-0" step="0.1"></li></span>
                            <li><span data-unit="%" class="percentage_sum position-relative"><input type="number" id="crit_rate_medal" class="crit_rate bg-transparent text-white text-right font-weight-bolder border-0" min="0" step="0.1"></li></span>
                            <li><span data-unit="%" class="percentage_sum position-relative"><input type="number" id="crit_rate_support" class="crit_rate bg-transparent text-white text-right font-weight-bolder border-0" min="0" step="0.1"></li></span>
                            <li><span data-unit="%" class="percentage_sum position-relative"><input type="number" id="crit_rate_divine_keys" class="crit_rate bg-transparent text-white text-right font-weight-bolder border-0" min="0" step="1" max="4"></li></span>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <td class="font-weight-bold pl-3"><label for="crit_dmg">爆擊傷害</label>
                        <a class="btn btn-sm btn-outline-info" data-toggle="collapse" href="#crit_dmg_sum" role="button" aria-expanded="false" aria-controls="collapse" id="crit_dmg_sum_help">加總小幫手</a>
                        <ul class="list-unstyled collapse p-1 h5 text-right" id="crit_dmg_sum">
                            <li class="sum_li"><label for="crit_dmg_leader_skill">隊長技能</label></li>
                            <li class="sum_li"><label for="crit_dmg_passive">被動技能</label></li>
                            <li class="sum_li"><label for="crit_dmg_weapon">武器加成</label></li>
                            <li class="sum_li"><label for="crit_dmg_stigmata">聖痕加成</label></li>
                            <li class="sum_li">
                                <img src="./img/BtnInfo.png" alt="info" class="info_s" data-toggle="tooltip" data-placement="left" data-html="true" title="詛咒之劍勳章 5%<br>逆天者 3%<br>亞空的毀滅者 5%">
                                <label for="crit_dmg_medal">勳章加成</label>
                            </li>
                            <li class="sum_li"><label for="crit_dmg_support">隊友輔助</label></li>
                        </ul>
                    </td>
                    <td class="text-right font-weight-bolder pr-3">
                        <div><span id="crit_dmg_text">0</span> %</div>
                        <!-- <input type="number" id="crit_dmg" class="bg-transparent text-white text-right font-weight-bolder border-0" min="0" step="0.1">% -->
                        <ul class=" list-unstyled collapse p-1 h5" id="crit_dmg_sum">
                            <li><input type="number" id="crit_dmg_leader_skill" class="crit_dmg bg-transparent text-white text-right font-weight-bolder border-0" min="0" step="0.1"></li>
                            <li><input type="number" id="crit_dmg_passive" class="crit_dmg bg-transparent text-white text-right font-weight-bolder border-0" step="0.1"></li>
                            <li><input type="number" id="crit_dmg_weapon" class="crit_dmg bg-transparent text-white text-right font-weight-bolder border-0" step="0.1"></li>
                            <li><input type="number" id="crit_dmg_stigmata" class="crit_dmg bg-transparent text-white text-right font-weight-bolder border-0" step="0.1"></li>
                            <li><input type="number" id="crit_dmg_medal" class="crit_dmg bg-transparent text-white text-right font-weight-bolder border-0" min="0" step="0.1"></li>
                            <li><input type="number" id="crit_dmg_support" class="crit_dmg bg-transparent text-white text-right font-weight-bolder border-0" min="0" step="0.1"></li>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <td class="result font-weight-bold pl-3 pt-2 pb-2">最終爆擊率</td>
                    <td class="result text-right font-weight-bolder font-italic pr-3"><span id="final_crit_rate">0</span> %</td>
                </tr>
                <tr>
                    <td class="font-weight-bold pl-3">
                        <img src="./img/VEL03.png" alt="三星詞綴" title="詞綴" class="affix_icon">
                        <label for="affix_atk">攻擊</label>
                        <img src="./img/BtnInfo.png" alt="info" class="info" data-toggle="tooltip" data-placement="right" data-html="true" title="有限定角色單條最高 23<br>無限定角色單條最高 19">
                    </td>
                    <td class="text-right align-middle pr-3"><input type="number" id="affix_atk" class="bg-transparent text-white text-right font-weight-bolder border-0" min="0" step="0.1"></td>
                </tr>
                <tr>
                    <td class="font-weight-bold pl-3">
                        <img src="./img/VEL03.png" alt="三星詞綴" title="詞綴" class="affix_icon">
                        <label for="affix_crt">會心</label>
                        <img src="./img/BtnInfo.png" alt="info" class="info" data-toggle="tooltip" data-placement="right" title="單條最高 13">
                    </td>
                    <td class="text-right align-middle pr-3"><input type="number" id="affix_crt" class="bg-transparent text-white text-right font-weight-bolder border-0" min="0" step="0.1"></td>
                </tr>
                <tr>
                    <td class="font-weight-bold pl-3">
                        <img src="./img/VEL03.png" alt="三星詞綴" title="詞綴" class="affix_icon">
                        <label for="affix_crit_dmg">爆擊傷害</label>
                        <img src="./img/BtnInfo.png" alt="info" class="info" data-toggle="tooltip" data-placement="right" title="單條最高 5.6%">
                    </td>
                    <td class="text-right align-middle font-weight-bolder pr-3">
                        <span data-unit="%" class="percentage position-relative">
                            <input type="number" id="affix_crit_dmg" class="bg-transparent text-white text-right font-weight-bold border-0" min="0" step="0.01">
                        </span>
                    </td>
                </tr>
                <tr>
                    <td class="result font-weight-bold pl-3 pt-2 pb-2">詞綴期望提升</td>
                    <td class="result text-right font-weight-bolder font-italic pr-3"><span id="exp_up">0</span> %</td>
                </tr>
            </table>
        </div>
        <div class="hidden shadow bg-white rounded text-center border col-10 align-middle position-absolute p-4" id="popup">
            <img src="./img/teriri_headshot.png" id="teriri_headshot" alt="觀星頭像"><span id="teriri_chat" class="align-middle h4"></span>
        </div>
    </div>
</body>
<script>
    // 計算
    $('table').delegate('input', 'change', function () {
        // 女武神
        var level = Number($('#level').val());
        var atk = Number($('#atk').val());
        var crt =  Number($('#crt').val());
        var final_crit_rate = $('#final_crit_rate');
        // 詞綴
        var affix_atk = Number($('#affix_atk').val());
        var affix_crt = Number($('#affix_crt').val());
        var affix_crit_dmg = Number($('#affix_crit_dmg').val());
        // 期望提升
        var exp_up = $('#exp_up');

        // 加總小幫手
        var crit_rate_sum = 0;
        $('.crit_rate').each(function () {
            var v = parseFloat(this.value);
            if (!isNaN(v)) {
                crit_rate_sum += v;
                this.value = v;
            } else {
                this.value = '';
            }
        });
        $('#crit_rate_text').text(crit_rate_sum);
        var crit_rate = crit_rate_sum;

        var crit_dmg_sum = 0;
        $('.crit_dmg').each(function () {
            var v = parseFloat(this.value);
            if (!isNaN(v)) {
                crit_dmg_sum += v;
                this.value = v;
            } else {
                this.value = '';
            }
        });
        $('#crit_dmg_text').text(crit_dmg_sum);
        var crit_dmg = crit_dmg_sum;
 
        // 爆擊率上限100%
        var affix_final_crit_rate = 0;
        fcr = Math.floor( crt/(level*5 + 75)*100 ) + crit_rate;
        affix_fcr = Math.floor( (crt + affix_crt)/(level*5 + 75)*100 ) + crit_rate;
        if( fcr > 100 ){
            final_crit_rate.text(100);    
            affix_final_crit_rate = 100;
        }else if( affix_fcr > 100 ){
            affix_final_crit_rate = 100;
        }else{
            final_crit_rate.text(fcr);
            affix_final_crit_rate = affix_fcr;
        }

        // 期望傷害
        var exp_dmg =  atk*(1 - final_crit_rate.text()/100 + final_crit_rate.text()/100 * (2 + crit_dmg/100)) ;
        var affix_exp_dmg =  (atk+affix_atk)*(1 - affix_final_crit_rate/100 + affix_final_crit_rate/100 * (2 + (crit_dmg+affix_crit_dmg)/100)) ;
        // 詞綴期望提升
        if (atk) {
            exp_up.text( ( (affix_exp_dmg/exp_dmg-1) * 100 ).toFixed(2) );
        }
    });

    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    })
    $(function () {
        $('[data-toggle="popover"]').popover()
    })

    // 設定teriri id
    var teriri_id = 0;

    // 召喚teriri
    function summon_teriri(){
        $(".container-fluid").append(`<img src="./img/teriri.png" class="hidden teriri position-absolute" id="teriri${teriri_id}">`);
        $(".teriri").fadeIn("slow");
        $(`#teriri${teriri_id}`).css("left", rand(70)+"%");
        $(`#teriri${teriri_id}`).css("top", rand(70)+"%");
        move_teriri(teriri_id,3000);
        // teriri_id++;
    }

    // 移動teriri
    function move_teriri(id,speed){
        $(`#teriri${id}`).animate({left: rand(80)-10+"%",top: rand(80)-10+"%"},speed,"swing",function(){
            move_teriri(id,speed);
        });
    }

    // 旋轉 
    var angle = 0;
    setInterval(function(){
        angle+=1;
        $(`#teriri${teriri_id}`).rotate(angle);
    },10);

    // 隨機 0 到 num 的數字
    function rand(num){
        return Math.floor( Math.random()*num );
    }
    
    // 幾秒後召喚teriri
    setTimeout(function(){
        summon_teriri();
    },rand(10000));
    // },1000);

    var Today=new Date();

    // 對話
    var teriri_chat_morning = new Array(
        "唉～早安，我都看了幾個時辰的書了",
        "終於醒了嗎，呵～沒想到身為艦長的你也如此貪睡",
    );
    var teriri_chat_noon = new Array(
        "我不喜歡睡午覺，那是只有小孩子才熱衷的活動",
    );
    var teriri_chat_afternoon = new Array(
        "唉～果然不睡午覺的話還是會很睏",
    );
    var teriri_chat_night = new Array(
        "這裡不需要疲憊的戰士，吾輩命令你現在就去休息",
        "夜深了，請早些休息。還是說，你有話想和我說？",
        "既然睡不著，就來陪我看看星空吧，你想了解星象嗎",
    );
    var teriri_chat_newyear = new Array(
        "外面很是熱鬧，要和我一起去逛新年廟會嗎",
    );
    var teriri_chat_rita = new Array(
        "今日是煌國宰相麗塔的誕辰，我想你應該沒有忘記吧",
    );
    var teriri_chat_shaking = new Array(
        "欸！怎麼突然晃得這麼厲害？今日應該沒有大風才對",
        "再進行這種幼稚的行為，我可要喊人了，真的要喊人了",
        "你只會用這種小把戲，來吸引我的注意力嗎？唉～真是幼稚",
        "什麼？有敵人入侵了嗎",
    );
    var teriri_chat = new Array(
        "啊～嗯？你剛剛說了什麼？快點告訴我",
        "這麼做就能讓你打起精神來工作了嗎，奇怪的要求",
        "但凡事我拆解過的物件，皆可復原。什麼？你不信？",
        "無禮之徒，為何一直盯著我看？難道說，不好看嗎？",
        "喵～是這樣嗎？哼～沒想到你居然好這口，真是人不可貌相",
        "那個德麗莎太過分了！他竟然……竟然在假扮我給大家算卦",
        "若是沒有你，我應該早已經葬身於那片樹海之中了吧",
        "你說我世界第一可愛？你這個人，又在說奇怪的話了",
        "只是完成了一天的任務而已，可不要這樣就得意忘形了",
        "為什麼給我準備了苦瓜汁？那種東西，是人喝的嗎",
        "都說了我對這種黃色的玩偶並不感興……欸？抱起來好軟",
        "今日你陪吾輩也夠久了刺客先生，去做你想做的事吧",      
        "難得一日無事，你不打算和我一起出去逛逛嗎，刺客先生",
        "想和我去吼姆樂園？呵～你還真是可愛啊，刺客先生",
        "啊！我的扇子去哪啦，剛才還在這的，那麼大一個呢",
        "箕星好風，畢星好雨。閒來無事，我教你些觀天象之術吧",
        "唉～朝日漫漫，真是無趣，快過來陪我聊聊天",
        "你的手總是那麼溫暖，謝謝，感覺好多了",
        "在找這個？我方才將他拆下來研究，還未來的及裝回去",
        "有陣子沒和你一起下棋了，今晚有興趣對弈幾局嗎",
        "不必道謝，守護你，這便是我身為觀星的責任",
        "坦言說，自與你相遇之後，感覺時間過得真快",
        "新衣服？嗯，比起最初認識你的時候，品味算是長進了不少",
        "竟然要努力工作來討吾輩的歡心，哼～還真是有趣的想法呢",
        "喵～行了吧，這是說好的獎勵，這周的工作完成的不錯",
        "嗯～書上說這樣會更可愛。欸！我這是在做什麼呢",
    );
    
    // 點teriri 停止移動並對話
    var first_click = true;
    $("body").on("click", ".teriri", function(teriri_event){
        $(".teriri").stop();
        $("#popup").show('1000').removeClass('hidden');

        if(first_click){
            first_click = false;
            if( (Today.getMonth()+1)==1 && Today.getDate()==1 ){
                $("#teriri_chat").html("："+teriri_chat_newyear);
            }else if( (Today.getMonth()+1)==3 && Today.getDate()==1 ){
                $("#teriri_chat").html("："+teriri_chat_rita);
            }else if( Today.getHours()>=8 && Today.getHours()<=10 ){
                $("#teriri_chat").html("："+teriri_chat_morning[rand(teriri_chat_morning.length)]);
            }else if( Today.getHours()>=12 && Today.getHours()<=13 ){
                $("#teriri_chat").html("："+teriri_chat_noon);
            }else if( Today.getHours()>=14 && Today.getHours()<=15 ){
                $("#teriri_chat").html("："+teriri_chat_afternoon);
            }else if( Today.getHours()>=22 ){
                $("#teriri_chat").html("："+teriri_chat_night[rand(teriri_chat_night.length)]);
            }else{
                $("#teriri_chat").html("："+teriri_chat[rand(teriri_chat.length)]);
            }
        }else{
            $("#teriri_chat").html("："+teriri_chat[rand(teriri_chat.length)]);
        }

        $("body").click(function(evt) {
            if($(evt.target).parents("#popup").length == 0 && evt.target.id != "popup") {
                $('#popup').hide('1000');
                $(".teriri").stop();
                move_teriri(teriri_id,3000);
            }
        });

        teriri_event.stopPropagation();
    });

    //搖一搖(使用DeviceMotion事件, 推薦,應為可以計算加速度)
    if(window.DeviceMotionEvent) {
        var speed = 10;    // 用來判定的加速度閾值，太大了則很難觸發
        var x, y, z, lastX, lastY, lastZ;
        x = y = z = lastX = lastY = lastZ = 0;
        window.addEventListener('devicemotion', function(event){
            var acceleration = event.accelerationIncludingGravity;
            x = acceleration.x;
            y = acceleration.y;
            if(Math.abs(x-lastX) > speed || Math.abs(y-lastY) > speed) {
                // 使用者裝置搖動了，觸發響應操作
                // 此處的判斷依據是使用者裝置的加速度大於我們設定的閾值
                $(".teriri").stop();
                move_teriri(teriri_id,30);

                $("#popup").show('1000').removeClass('hidden');
                $("#teriri_chat").html("："+teriri_chat_shaking[rand(teriri_chat_shaking.length)]);

                $("body").click(function(evt) {
                    if($(evt.target).parents("#popup").length == 0 && evt.target.id != "popup") {
                        $('#popup').hide('1000');
                        $(".teriri").stop();
                        move_teriri(teriri_id,3000);
                    }
                });
            }
            lastX = x;
            lastY = y;
        }, false);
    }
</script>
</html>